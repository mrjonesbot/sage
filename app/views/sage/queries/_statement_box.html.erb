<%= turbo_stream_from "statements" %>

<style>
  @keyframes glow-border {
    0% {
      outline: 2px solid rgba(66, 165, 245, 0.8);
      outline-offset: 0px;
    }
    50% {
      outline: 2px solid rgba(66, 165, 245, 1);
      outline-offset: 3px;
    }
    100% {
      outline: 2px solid rgba(66, 165, 245, 0.8);
      outline-offset: 0px;
    }
  }
  
  .glow-button {
    animation: glow-border 1.5s ease-in-out infinite;
    position: relative;
  }
  
  .glow-button:hover {
    animation-play-state: paused;
    outline: 2px solid rgba(66, 165, 245, 1);
    outline-offset: 2px;
  }
</style>

<div id=<%= dom_id(query, 'statement-box') %> class='' style="position: relative;">
  <% 
    # Handle different contexts - job vs regular view rendering
    form_url = if local_assigns[:form_url]
      local_assigns[:form_url]
    elsif defined?(sage) && sage.respond_to?(:run_queries_path)
      sage.run_queries_path
    elsif respond_to?(:run_queries_path)
      run_queries_path
    else
      # Fallback to engine route
      Sage::Engine.routes.url_helpers.run_queries_path
    end
  %>
  <%= form_with url: form_url, method: :post do |f| %>
    <%= f.hidden_field :statement, id: 'query_statement' %>
    <%= f.hidden_field :query_id, value: query.id %>
    <%= f.hidden_field :data_source, value: query.data_source || Blazer.data_sources.keys.first %>
    <div id="editor-container" style="position: relative; overflow: hidden;">
      <div id="editor" style="height: 200px;" data-initial-content="<%= html_escape(local_assigns[:statement] || query.statement) %>"><%= local_assigns[:statement] || query.statement %></div>
      <div style="position: absolute; bottom: 10px; right: 15px; z-index: 1000; border-radius: 4px; padding: 5px;">
        <button type='submit' class="<%= 'glow-button' if local_assigns[:statement].present? %>">Run</button>
      </div>
    </div>
  <% end %>
</div>

<%= javascript_tag nonce: true do %>
  function initializeEditor() {
  // Destroy existing editor if it exists
  if (window.aceEditor) {
    window.aceEditor.destroy();
  }
  
  var editor = ace.edit("editor")
  window.aceEditor = editor;
  editor.setTheme("ace/theme/twilight")
  editor.getSession().setMode("ace/mode/sql")
  editor.setOptions({
  enableBasicAutocompletion: false,
  enableSnippets: false,
  enableLiveAutocompletion: false,
  highlightActiveLine: false,
  fontSize: 12,
  minLines: 10
  })
  editor.renderer.setShowGutter(true)
  editor.renderer.setPrintMarginColumn(false)
  editor.setShowPrintMargin(false)
  editor.renderer.setPadding(10)
  editor.getSession().setUseWrapMode(true)
  
  // Ensure scrolling works properly with bottom margin
  editor.renderer.setScrollMargin(0, 0, 50, 0)  // top, right, bottom, left margins
  editor.setAutoScrollEditorIntoView(true)

  // Update both hidden fields when editor content changes
  editor.getSession().on("change", function () {
  const value = editor.getValue()
  $("#query_statement").val(value)  // For run form
  $("#query_statement_form").val(value)  // For main form
  })

  // Set initial value from data attribute or current content
  const editorDiv = document.getElementById("editor")
  const initialContent = editorDiv.getAttribute("data-initial-content") || editor.getValue()
  
  if (initialContent && initialContent !== editor.getValue()) {
    editor.setValue(initialContent, -1) // -1 moves cursor to start
  }
  
  const initialValue = editor.getValue()
  $("#query_statement").val(initialValue)
  $("#query_statement_form").val(initialValue)
  editor.focus()

  // Add top padding to ace_scroller and gutter to keep them aligned
  const aceScroller = document.querySelector('.ace_scroller');
  const aceGutter = document.querySelector('.ace_gutter');

  if (aceScroller) {
  aceScroller.style.paddingTop = '10px';
  }
  if (aceGutter) {
  aceGutter.style.paddingTop = '10px';
  }
  }

  // Initialize on page load
  document.addEventListener('turbo:load', initializeEditor);
  
  // Initialize when this partial is replaced via Turbo Stream
  document.addEventListener('turbo:frame-load', initializeEditor);
  
  // Also initialize immediately if the DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEditor);
  } else {
    initializeEditor();
  }
<% end %>
