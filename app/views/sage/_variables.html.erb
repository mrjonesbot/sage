<% if @bind_vars.any? %>
  <% var_params = request.query_parameters %>
  <%= javascript_tag nonce: true do %>
    <%= blazer_js_var "timeZone", Blazer.time_zone.tzinfo.name %>
    var now = moment.tz(timeZone)
    var format = "YYYY-MM-DD"

    function toDate(time) {
      return moment.tz(time.format(format), timeZone)
    }
  <% end %>
  
  <!-- Filter Navigation Area -->
  <div class="surface border left-round" style="padding: 16px; margin-bottom: 20px; background-color: #f8f9fa;">
    <h6 style="margin: 0 0 16px 0; color: #6b7280; font-weight: 500;">Query Filters</h6>
    
    <div data-controller="sage--variables" data-sage--variables-form-target="form">
      <form id="bind" method="get" action="<%= action %>">
        <div class="grid">
          <% date_vars = ["start_time", "end_time"] %>
          <% if (date_vars - @bind_vars).empty? %>
            <% @bind_vars = @bind_vars - date_vars %>
          <% else %>
            <% date_vars = nil %>
          <% end %>

          <% @bind_vars.each_with_index do |var, i| %>
            <div class="s12 m6 l4" style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 6px; color: #6b7280; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
                {<%= var %>}
              </label>
              <% if (data = @smart_vars[var]) %>
                <%= select_tag var, options_for_select([[nil, nil]] + data, selected: var_params[var]), 
                    style: "width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; height: 42px; box-sizing: border-box;", 
                    data: { "sage--variables-target": "variable" } %>
                <%= javascript_tag nonce: true do %>
                  $("#<%= var %>").selectize({
                    create: true
                  });
                <% end %>
              <% elsif var.end_with?("_at") || var == "start_time" || var == "end_time" %>
                <%= hidden_field_tag var, var_params[var], data: { "sage--variables-target": "variable" } %>
                <div id="<%= var %>-select" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; color: #6b7280; height: 42px; box-sizing: border-box; display: flex; align-items: center;">
                  <span>Select a date</span>
                </div>

          <%= javascript_tag nonce: true do %>
            (function() {
              var input = $("#<%= var %>")
              var datePicker = $("#<%= var %>-select")
              datePicker.daterangepicker({
                singleDatePicker: true,
                locale: {format: format},
                autoUpdateInput: false,
                autoApply: true,
                startDate: input.val().length > 0 ? moment.tz(input.val(), timeZone) : now
              })
              // hack to start with empty date
              datePicker.on("apply.daterangepicker", function(ev, picker) {
                datePicker.find("span").html(toDate(picker.startDate).format("MMMM D, YYYY"))
                input.val(toDate(picker.startDate).utc().format())
                
                // Trigger our custom variable controller instead of submitIfCompleted
                var controller = document.querySelector('[data-controller*="sage--variables"]')
                if (controller && window.Stimulus) {
                  var controllerInstance = window.Stimulus.getControllerForElementAndIdentifier(controller, 'sage--variables')
                  if (controllerInstance) {
                    controllerInstance.handleDateRangeChange(input[0], picker)
                  }
                }
              })
              if (input.val().length > 0) {
                var picker = datePicker.data("daterangepicker")
                datePicker.find("span").html(toDate(picker.startDate).format("MMMM D, YYYY"))
              }
            })()
          <% end %>
              <% else %>
                <%= text_field_tag var, var_params[var], 
                    style: "width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; height: 42px; box-sizing: border-box;", 
                    autofocus: i == 0 && !var.end_with?("_at") && !var_params[var], 
                    data: { "sage--variables-target": "variable" }, 
                    placeholder: "Enter #{var.humanize.downcase}" %>
              <% end %>
            </div>
          <% end %>

          <% if date_vars %>
            <% date_vars.each do |var| %>
              <%= hidden_field_tag var, var_params[var], data: { "sage--variables-target": "variable" } %>
            <% end %>
            
            <div class="s12 m6 l4" style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 6px; color: #6b7280; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
                {<%= date_vars.join('}, {') %>}
              </label>
              <div id="reportrange" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; color: #6b7280; height: 42px; box-sizing: border-box; display: flex; align-items: center;">
                <span>Select a time range</span>
              </div>
            </div>
          <% end %>
        </div>
        
        <div class="right-align" style="margin-top: 16px;">
          <button type='submit' class='button primary'>
            <i>play_arrow</i>
            Run Query
          </button>
        </div>
      </form>
    </div>
  </div>

        <%= javascript_tag nonce: true do %>
          function dateStr(daysAgo) {
            return now.clone().subtract(daysAgo || 0, "days").format(format)
          }

          function setTimeInputs(start, end) {
            $("#start_time").val(toDate(start).utc().format())
            $("#end_time").val(toDate(end).endOf("day").utc().format())
          }

          $("#reportrange").daterangepicker(
            {
              ranges: {
               "Today": [dateStr(), dateStr()],
               "Last 7 Days": [dateStr(6), dateStr()],
               "Last 30 Days": [dateStr(29), dateStr()]
              },
              locale: {
                format: format
              },
              startDate: dateStr(29),
              endDate: dateStr(),
              opens: "right",
              alwaysShowCalendars: true
            },
            function(start, end) {
              setTimeInputs(start, end)
              
              // Trigger our custom variable controller instead of submitIfCompleted
              var controller = document.querySelector('[data-controller*="sage--variables"]')
              if (controller && window.Stimulus) {
                var controllerInstance = window.Stimulus.getControllerForElementAndIdentifier(controller, 'sage--variables')
                if (controllerInstance) {
                  controllerInstance.triggerSubmit()
                }
              }
            }
          ).on("apply.daterangepicker", function(ev, picker) {
            setTimeInputs(picker.startDate, picker.endDate)
            $("#reportrange span").html(toDate(picker.startDate).format("MMMM D, YYYY") + " - " + toDate(picker.endDate).format("MMMM D, YYYY"))
            
            // Trigger our custom variable controller
            var controller = document.querySelector('[data-controller*="sage--variables"]')
            if (controller && window.Stimulus) {
              var controllerInstance = window.Stimulus.getControllerForElementAndIdentifier(controller, 'sage--variables')
              if (controllerInstance) {
                controllerInstance.handleDateRangeChange(document.getElementById('start_time'), picker)
              }
            }
          })

          if ($("#start_time").val().length > 0) {
            var picker = $("#reportrange").data("daterangepicker")
            picker.setStartDate(moment.tz($("#start_time").val(), timeZone))
            picker.setEndDate(moment.tz($("#end_time").val(), timeZone))
            $("#reportrange").trigger("apply.daterangepicker", picker)
          } else {
            var picker = $("#reportrange").data("daterangepicker")
            $("#reportrange").trigger("apply.daterangepicker", picker)
            
            // Initial trigger for our custom controller
            var controller = document.querySelector('[data-controller*="sage--variables"]')
            if (controller && window.Stimulus) {
              var controllerInstance = window.Stimulus.getControllerForElementAndIdentifier(controller, 'sage--variables')
              if (controllerInstance) {
                controllerInstance.triggerSubmit()
              }
            }
          }
        <% end %>
<% end %>
